name: Exportar Diagrama y Notificar a Telegram

on:
  push:
    paths:
      - 'doc/diagramaConceptual.drawio'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  convert-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verificar archivos y crear carpetas
        run: |
          echo "üìÇ Estructura actual de archivos:"
          ls -R
          echo "--------------------------------"
          echo "üõ† Creando carpeta export..."
          mkdir -p export

      - name: Convertir Draw.io a JPG
        uses: rlespinasse/drawio-export-action@v2
        with:
          path: doc/
          format: jpg
          output: export/
          action-mode: all

      - name: üîç Debug - Listar archivos generados
        run: |
          echo "Listando contenido de la carpeta export:"
          ls -R export/

      - name: Enviar a Telegram
        env:
          TOKEN: ${{ secrets.APIKEY_BOT_TELEGRAM }}
          CHAT_ID: ${{ secrets.ID_GROUP_TELEGRAM }}
          TOPIC_ID: '114'
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendPhoto" \
            -F chat_id="$CHAT_ID" \
            -F message_thread_id="$TOPIC_ID" \
            -F photo="@export/diagramaConceptual.jpg" \
            -F caption="**Diagrama Conceptual Actualizado**" \
            -F parse_mode="Markdown"