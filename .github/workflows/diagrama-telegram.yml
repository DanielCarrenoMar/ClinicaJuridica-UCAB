name: Exportar Diagrama y Notificar a Telegram

on:
  push:
    paths:
      - 'doc/diagramaConceptual.drawio'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  convert-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üîç Verificar fuente
        run: |
          if [ -f "doc/diagramaConceptual.drawio" ]; then
            echo "‚úÖ Archivo fuente encontrado."
            ls -l doc/diagramaConceptual.drawio
          else
            echo "‚ùå ERROR: No se encuentra doc/diagramaConceptual.drawio"
            exit 1
          fi

      - name: Convertir Draw.io a JPG
        uses: rlespinasse/drawio-export-action@v2
        with:
          path: doc
          format: jpg
          action-mode: all

      - name: Enviar a Telegram
        env:
          TOKEN: ${{ secrets.APIKEY_BOT_TELEGRAM }}
          CHAT_ID: ${{ secrets.ID_GROUP_TELEGRAM }}
          TOPIC_ID: '114'
        run: |
          shopt -s nullglob
          jpg_files=(doc/export/*.jpg)

          if [ ${#jpg_files[@]} -gt 0 ]; then
            for FILE in "${jpg_files[@]}"; do
              echo "‚úÖ Enviando imagen: $FILE"
              CAPTION="$(basename "$FILE" .jpg)"

              curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendPhoto" \
                -F chat_id="$CHAT_ID" \
                -F message_thread_id="$TOPIC_ID" \
                -F photo="@$FILE" \
                -F caption="$CAPTION" \
                -F parse_mode="Markdown"
            done
          else
            echo "‚ùå ERROR: La acci√≥n termin√≥ pero no gener√≥ archivos JPG en la carpeta doc/export/."
            echo "Contenido de la carpeta doc/:"
            ls -R doc/
            exit 1
          fi