name: Exportar Diagrama y Notificar a Telegram

on:
  push:
    paths:
      - 'doc/diagramaConceptual.drawio'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  convert-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üîç Verificar fuente
        run: |
          if [ -f "doc/diagramaConceptual.drawio" ]; then
            echo "‚úÖ Archivo fuente encontrado."
            ls -l doc/diagramaConceptual.drawio
          else
            echo "‚ùå ERROR: No se encuentra doc/diagramaConceptual.drawio"
            exit 1
          fi

      - name: Convertir Draw.io a JPG
        uses: rlespinasse/drawio-export-action@v2
        with:
          path: doc
          format: jpg
          action-mode: all

      - name: Enviar a Telegram
        env:
          TOKEN: ${{ secrets.APIKEY_BOT_TELEGRAM }}
          CHAT_ID: ${{ secrets.ID_GROUP_TELEGRAM }}
          TOPIC_ID: '114'
        run: |
          FILE=$(find doc -name "*.jpg" | head -n 1)
          if [ -n "$FILE" ]; then
            echo "‚úÖ Imagen generada en: $FILE"
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendPhoto" \
              -F chat_id="$CHAT_ID" \
              -F message_thread_id="$TOPIC_ID" \
              -F photo="@$FILE" \
              -F caption="**Diagrama Conceptual Actualizado**" \
              -F parse_mode="Markdown"
          else
            echo "‚ùå ERROR: La acci√≥n termin√≥ pero no gener√≥ el archivo JPG en la carpeta doc/."
            echo "Contenido de la carpeta doc/:"
            ls -la doc/
            exit 1
          fi