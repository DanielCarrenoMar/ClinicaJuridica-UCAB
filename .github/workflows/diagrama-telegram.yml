name: Exportar Diagrama y Notificar a Telegram

on:
  push:
    paths:
      - 'doc/diagramaConceptual.drawio'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  convert-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Preparar archivo
        run: |
          mkdir -p temp_work
          # Copiamos el archivo a una carpeta temporal limpia
          cp doc/diagramaConceptual.drawio temp_work/diagrama.drawio
          mkdir -p export

      - name: Convertir Draw.io a JPG
        uses: rlespinasse/drawio-export-action@v2
        with:
          # Ahora le decimos: trabaja SOLO en esta carpeta temporal
          path: temp_work
          format: jpg
          output: export
          action-mode: all

      - name: üîç Debug - Listar archivos generados
        run: |
          echo "Listando contenido de la carpeta export:"
          ls -R export/

      - name: Enviar a Telegram (Con Topic)
        if: success()
        env:
          TOKEN: ${{ secrets.APIKEY_BOT_TELEGRAM }}
          CHAT_ID: ${{ secrets.ID_GROUP_TELEGRAM }}
          TOPIC_ID: '114'
        run: |
          # Como renombramos el archivo a 'diagrama.drawio', la salida ser√° 'diagrama.jpg'
          # La acci√≥n suele replicar la estructura, as√≠ que buscamos en export/temp_work/ o directo en export/
          
          FILE=$(find export -name "*.jpg" | head -n 1)
          
          if [ -n "$FILE" ]; then
            echo "‚úÖ Imagen encontrada en: $FILE"
            curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendPhoto" \
              -F chat_id="$CHAT_ID" \
              -F message_thread_id="$TOPIC_ID" \
              -F photo="@$FILE" \
              -F caption="**Diagrama Conceptual Actualizado**" \
              -F parse_mode="Markdown"
          else
            echo "‚ùå ERROR: No se gener√≥ ninguna imagen."
            exit 1
          fi