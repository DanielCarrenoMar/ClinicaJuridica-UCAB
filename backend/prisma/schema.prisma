generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//CONSIDERACIONES
/*
1) Los nombres pasan a tener dos atributos (firstName, lastName) en vez de uno solo (fullName)
*/

enum CaseStatusType {
  OPEN
  IN_PROGRESS
  ON_PAUSE
  CLOSED
}

enum GenderType {
  M
  F
  O
}

enum ColaboratorType {
  CJ_1
  CJ_2
  VOLUNTEER
}

enum IDType {
  V
  E
  J
}

enum WorkConditionType {
  EMPLOYER
  EMPLOYEE
  WORKER
  SELF_EMPLOYED
}

enum ActivityConditionType {
  HOUSEWIFE
  STUDENT
  RETIRED
  OTHER
}

enum WasteCollectionType {
  HOME_COLLECTION
  PUBLIC_CONTAINER
  NONE
}

enum WastewaterType {
  SEWER_OR_SEPTIC
  UNCONNECTED_TOILET
  LATRINE
  NONE
}

enum WaterServiceType {
  INDOOR
  OUTDOOR
  NONE
}

enum RoofMaterialType {
  WOOD_PALM_CARDBOARD
  ZINC_SHEET
  CONCRETE_OR_TILES
}

enum WallMaterialType {
  WASTE_MATERIALS
  BAHAREQUE
  UNPLASTERED_BLOCK
  PLASTERED_BLOCK
}

enum FloorMaterialType {
  DIRT
  CEMENT
  CERAMIC
  GRANITE_PARQUET_MARBLE
}

model User {
  idUser      Int       @id //Cedula de identidad
  firstName   String
  lastName    String
  gender GenderType
  email       String    @unique
  isActive    Boolean   @default(true)
  password    String?

  // Relaciones
  caseStatus  CaseStatus[]
  colaborator Colaborator?
  teacher Teacher?

  @@map("users")
}

model Colaborator {
  idUser Int @id
  typeColaborator ColaboratorType

  user User @relation(fields: [idUser], references: [idUser])

  @@map("colaborators")
}

model Teacher {
  idUser Int @id
  isAdmin Boolean @default(false)

  user User  @relation(fields: [idUser], references: [idUser])
}

model CaseStatus {
  idCaseStatus Int @default(autoincrement())
  idUser     Int
  idCase     Int
  statusCase CaseStatusType

  User User @relation(fields: [idUser], references: [idUser])
  Case Case @relation(fields: [idCase], references: [idCase])

  createdAt  DateTime @default(now())
  @@id([idCaseStatus, idUser, idCase])
  @@map("caseStatuses")
}

model Beneficiary {
  idBeneficiary Int @id // Cedula
  firstName String
  lastName String
  idType IDType
  birthDate DateTime
  gender GenderType

  idParish Int
  idCase Int

  parish Parish @relation(fields: [idParish], references: [idParish])
  case Case @relation(fields: [idCase], references: [idCase])

  @@map("beneficiaries")
}

model Applicant {
  idApplicant Int @id // Cedula de identidad
  firstName      String
  lastName       String
  email          String
  phoneCell      String
  phoneHome      String
  maritalStatus  String
  concubinage    Boolean
  isWorking     Boolean
  workCondition WorkConditionType?
  isLookingJob   Boolean
  activityCondition ActivityConditionType?
  isHouseHoldHead Boolean
  educationLevel Int // De 0 a 14
  educationMonths Int
  educationLevelHousehold Int? // De 0 a 14
  educationMonthsHousehold Int?

  // Vivienda
  typeResidence String?
  roomsAmount  Int?
  bathroomsAmount Int?
  roofMaterial      RoofMaterialType?
  wallMaterial      WallMaterialType?
  floorMaterial     FloorMaterialType?

  // Servicios
  waterService      WaterServiceType?
  wastewaterService WastewaterType?
  wasteCollection   WasteCollectionType?

  // Falta lo de artefactos domesticos que no se 
  // si son respuestas SI o no o por que ahora es multivaluado

  idFamilyHouse Int
  familyHouse   FamilyHouse @relation(fields: [idFamilyHouse], references: [idFamilyHouse])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@map("applicants")
}

model Parish {
  idParish Int @id @default(autoincrement())
  name String

  idMunicipality Int
  municipality municipality @relation(fields: [idMunicipality], references: [idMunicipality])

  @@map("parishes")
}

model municipality {
  idMunicipality Int @id @default(autoincrement())
  name String

  idRegion Int
  region Region @relation(fields: [idRegion], references: [id])
  parishes Parish[]

  @@map("municipalities")
}

model Region {
  id       Int       @id @default(autoincrement())
  name     String
  
  municipalities municipality[]

  @@map("regions")
}

model FamilyHouse {
  idFamilyHouse Int @id @default(autoincrement())
  memberWorkingCount Int
  membersNonWorkingCount Int
  childrens7to12Count Int
  childrensStudentCount Int
  monthlyIncome Float
  
  applicants Applicant[]

  @@map("familyHouses")
}

// POR REVISAR

model Case {
  idCase        Int      @id @default(autoincrement())
  caseNumber    String   @unique // Número de rol o carpeta interna
  entryDate     DateTime @default(now())
  description   String   @db.Text
  observations  String?  @db.Text
  
  // Estados y Clasificaciones
  status        CaseStatusType @default(OPEN)
  
  legalAreaId   Int
  legalArea     LegalArea  @relation(fields: [legalAreaId], references: [id]) // Materia

  courtId       Int?
  court         Court?     @relation(fields: [courtId], references: [id]) // Tribunal

  // Relaciones Principales
  applicantId   Int
  applicant     Applicant @relation(fields: [applicantId], references: [id])

  // Relaciones Secundarias
  assignments    CaseAssignment[] // Estudiantes/Profesores asignados
  documents      Document[]       // Documentos/Soportes
  opposingParties OpposingParty[] // Contraparte
  logs           CaseLog[]        // Historial de cambios
  beneficiaries  Beneficiary[]    // A quien beneficia el caso (si es distinto al solicitante)

  @@map("cases")
}

model CaseAssignment {
  id        Int      @id @default(autoincrement())
  startDate DateTime @default(now())
  endDate   DateTime?
  isActive  Boolean  @default(true)
  roleInCase String? // Rol específico en el caso si difiere del rol de usuario

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  caseId    Int
  case      Case     @relation(fields: [caseId], references: [id])

  @@map("case_assignments")
}

// --------------------------------------------------------
// LEGAL ENTITIES (Derecha del Diagrama)
// --------------------------------------------------------

model LegalArea {
  id          Int    @id @default(autoincrement())
  name        String // Ej: Familia, Civil, Laboral
  description String?
  cases       Case[]

  @@map("legal_areas")
}

model Court {
  id       Int    @id @default(autoincrement())
  name     String // Ej: 1er Juzgado de Letras
  address  String?
  city     String?
  cases    Case[]

  @@map("courts")
}

model OpposingParty {
  id        Int     @id @default(autoincrement())
  fullName  String
  rut       String?
  address   String?
  lawyer    String? // Abogado de la contraparte

  caseId    Int
  case      Case    @relation(fields: [caseId], references: [id])

  @@map("opposing_parties")
}

model Document {
  id         Int      @id @default(autoincrement())
  fileName   String
  fileUrl    String
  fileType   String   // PDF, DOCX, IMG
  uploadedAt DateTime @default(now())
  
  caseId     Int
  case       Case     @relation(fields: [caseId], references: [id])

  @@map("documents")
}

// --------------------------------------------------------
// SYSTEM LOGS (Historial)
// --------------------------------------------------------

model CaseLog {
  id          Int      @id @default(autoincrement())
  action      String   // "Created", "Updated Status", "File Uploaded"
  details     String?
  timestamp   DateTime @default(now())

  caseId      Int
  case        Case     @relation(fields: [caseId], references: [id])

  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])

  @@map("case_logs")
}