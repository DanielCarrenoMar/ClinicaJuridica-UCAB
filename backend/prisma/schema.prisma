generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

// Enums

enum Gender {
  M
  F
}

enum UserType {
  STUDENT
  TEACHER
  COORDINATOR
}

enum TeacherType {
  REGULAR
  VOLUNTEER // Visiting -> Voluntario
}

enum StudentType {
  REGULAR
  VOLUNTEER // Visiting -> Voluntario
  GRADUATE // External -> Egresado
  SERVICE
}

enum idNationality {
  VENEZUELAN
  FOREIGNER
  LEGAL
}

enum BeneficiaryType {
  BENEFICIARY
  APPLICANT // Spouse -> Solicitante
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum ProcessType {
  IN_PROGRESS // Tramite
  ADVICE // Asesoria
  MEDIATION // Conciliacion y mediacion
  DRAFTING // Redaccion
}

enum CaseBeneficiaryType {
  DIRECT
  INDIRECT
}

enum AppointmentStatus {
  CANCELLED
  SCHEDULED // Planificada
  COMPLETED // Realizada
}

enum CaseStatusEnum {
  OPEN // Abierto
  IN_PROGRESS // En Tramite
  PAUSED // En Pausa
  CLOSED // Cerrado
}

// Tables

model HousingCharacteristic {
  idCharacteristic Int     @id @default(autoincrement())
  name             String  @unique @db.VarChar(63)
  isActive         Boolean @default(true)

  details CharacteristicDetail[]
}

model EducationLevel {
  idLevel  Int     @id @default(autoincrement())
  name     String  @unique @db.VarChar(63)
  isActive Boolean @default(true)

  headApplicants Applicant[] @relation("HeadEducationLevel")
  applicants     Applicant[] @relation("ApplicantEducationLevel")
}

model State {
  idState Int    @id @default(autoincrement())
  name    String @unique @db.VarChar(63)

  municipalities Municipality[]
}

model WorkCondition {
  idCondition Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(63)
  isActive    Boolean @default(true)

  applicants Applicant[]
}

model ActivityCondition {
  idActivity Int     @id @default(autoincrement())
  name       String  @unique @db.VarChar(63)
  isActive   Boolean @default(true)

  applicants Applicant[]
}

model Court {
  idCourt  Int     @id @default(autoincrement())
  subject  String  @db.VarChar(63) // "materia"
  isActive Boolean @default(true)

  cases Case[]
}

model Semester {
  term      String   @id @db.VarChar(10)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date

  teachers Teacher[]
  students Student[]
  cases    Case[]
}

model Subject {
  idSubject Int     @id @default(autoincrement())
  name      String  @unique @db.VarChar(63)
  isActive  Boolean @default(true)

  categories SubjectCategory[]
}

model User {
  identityCard String   @id @db.VarChar(20)
  fullName     String   @db.VarChar(63)
  gender       Gender?
  email        String   @unique @db.VarChar(35)
  password     String   @db.VarChar(60)
  isActive     Boolean  @default(true)
  type         UserType

  coordinator Coordinator?
  // Implicit relations from subclasses
  teachers    Teacher[]
  students    Student[]

  caseActions  CaseAction[]
  appointments Appointment[]
  caseStatuses CaseStatus[]
}

model Coordinator {
  identityCard String @id @db.VarChar(20)

  user User @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)
}

model CharacteristicDetail {
  idCharacteristic Int
  detailNumber     Int
  option           String  @db.VarChar(63)
  isActive         Boolean @default(true)

  characteristic HousingCharacteristic @relation(fields: [idCharacteristic], references: [idCharacteristic], onDelete: Restrict, onUpdate: Cascade)
  housingDetails HousingDetail[]

  @@id([idCharacteristic, detailNumber])
  @@unique([idCharacteristic, option])
}

model Municipality {
  idState            Int
  municipalityNumber Int
  name               String @db.VarChar(63)

  state    State    @relation(fields: [idState], references: [idState], onDelete: Restrict, onUpdate: Cascade)
  parishes Parish[]

  @@id([idState, municipalityNumber])
  @@unique([idState, name])
}

model Parish {
  idState            Int
  municipalityNumber Int
  parishNumber       Int
  name               String @db.VarChar(63)

  municipality  Municipality  @relation(fields: [idState, municipalityNumber], references: [idState, municipalityNumber], onDelete: Restrict, onUpdate: Cascade)
  nuclei        Nucleus[]
  beneficiaries Beneficiary[]

  @@id([idState, municipalityNumber, parishNumber])
  @@unique([idState, municipalityNumber, name])
}

model Nucleus {
  idNucleus String  @id @db.VarChar(63)
  isActive  Boolean @default(true)

  idState            Int
  municipalityNumber Int
  parishNumber       Int

  parish Parish @relation(fields: [idState, municipalityNumber, parishNumber], references: [idState, municipalityNumber, parishNumber], onDelete: Restrict, onUpdate: Cascade)
  cases  Case[]
}

model SubjectCategory {
  idSubject      Int
  categoryNumber Int
  name           String  @db.VarChar(63)
  isActive       Boolean @default(true)

  subject    Subject     @relation(fields: [idSubject], references: [idSubject], onDelete: Restrict, onUpdate: Cascade)
  legalAreas LegalArea[]

  @@id([idSubject, categoryNumber])
  @@unique([idSubject, name])
}

model LegalArea {
  idLegalArea Int     @id @default(autoincrement())
  name        String  @db.VarChar(63)
  isActive    Boolean @default(true)

  idSubject      Int
  categoryNumber Int

  subjectCategory SubjectCategory @relation(fields: [idSubject, categoryNumber], references: [idSubject, categoryNumber], onDelete: Restrict, onUpdate: Cascade)
  cases           Case[]

  @@unique([idSubject, categoryNumber, name])
}

model Teacher {
  identityCard String      @db.VarChar(20)
  term         String      @db.VarChar(10)
  type         TeacherType

  user     User     @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)
  semester Semester @relation(fields: [term], references: [term], onDelete: Restrict, onUpdate: Cascade)

  cases Case[]

  @@id([identityCard, term])
}

model Student {
  identityCard String      @db.VarChar(20)
  term         String      @db.VarChar(10)
  nrc          String?     @db.VarChar(12)
  type         StudentType

  user     User     @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)
  semester Semester @relation(fields: [term], references: [term], onDelete: Restrict, onUpdate: Cascade)

  assignedCases AssignedStudent[]

  @@id([identityCard, term])
}

model Beneficiary {
  identityCard  String          @id @db.VarChar(20)
  gender        Gender
  birthDate     DateTime        @db.Date
  fullName      String          @db.VarChar(63)
  idNationality idNationality
  hasId         Boolean
  type          BeneficiaryType

  idState            Int?
  municipalityNumber Int?
  parishNumber       Int?

  parish            Parish?           @relation(fields: [idState, municipalityNumber, parishNumber], references: [idState, municipalityNumber, parishNumber], onDelete: Restrict, onUpdate: Cascade)
  applicant         Applicant?
  caseBeneficiaries CaseBeneficiary[]
}

model Applicant {
  identityCard      String         @id @db.VarChar(20)
  email             String?        @db.VarChar(35)
  cellPhone         String?        @db.VarChar(20)
  homePhone         String?        @db.VarChar(20)
  maritalStatus     MaritalStatus?
  isConcubine       Boolean?
  createdAt         DateTime       @default(now())
  isHeadOfHousehold Boolean?

  headEducationLevelId      Int?
  headStudyTime             String? @db.VarChar(35)
  applicantEducationLevelId Int?
  applicantStudyTime        String? @db.VarChar(35)

  workConditionId     Int?
  activityConditionId Int?

  beneficiary Beneficiary @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)

  headEducationLevel      EducationLevel? @relation("HeadEducationLevel", fields: [headEducationLevelId], references: [idLevel], onDelete: Restrict, onUpdate: Cascade)
  applicantEducationLevel EducationLevel? @relation("ApplicantEducationLevel", fields: [applicantEducationLevelId], references: [idLevel], onDelete: Restrict, onUpdate: Cascade)

  workCondition     WorkCondition?     @relation(fields: [workConditionId], references: [idCondition], onDelete: Restrict, onUpdate: Cascade)
  activityCondition ActivityCondition? @relation(fields: [activityConditionId], references: [idActivity], onDelete: Restrict, onUpdate: Cascade)

  housing    Housing?
  familyHome FamilyHome?
  cases      Case[]
}

model Housing {
  applicantId   String @id @db.VarChar(20)
  bathroomCount Int?
  bedroomCount  Int?

  applicant Applicant       @relation(fields: [applicantId], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)
  details   HousingDetail[]
}

model HousingDetail {
  idCharacteristic Int
  detailNumber     Int
  applicantId      String @db.VarChar(20)

  characteristicDetail CharacteristicDetail @relation(fields: [idCharacteristic, detailNumber], references: [idCharacteristic, detailNumber], onDelete: Restrict, onUpdate: Cascade)
  housing              Housing              @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade, onUpdate: Cascade)

  @@id([idCharacteristic, detailNumber, applicantId])
}

model FamilyHome {
  applicantId          String   @id @db.VarChar(20)
  memberCount          Int?
  workingMemberCount   Int?
  children7to12Count   Int?
  studentChildrenCount Int?
  monthlyIncome        Decimal? @db.Decimal(12, 2)

  applicant Applicant @relation(fields: [applicantId], references: [identityCard], onDelete: Cascade, onUpdate: Cascade)
}

model Case {
  idCase         Int         @id @default(autoincrement())
  problemSummary String
  createdAt      DateTime    @default(now())
  processType    ProcessType

  applicantId String  @db.VarChar(20)
  idNucleus   String  @db.VarChar(63)
  term        String  @db.VarChar(10)
  idLegalArea Int
  teacherId   String? @db.VarChar(20)
  teacherTerm String? @db.VarChar(10)
  idCourt     Int?

  applicant Applicant @relation(fields: [applicantId], references: [identityCard], onDelete: Restrict, onUpdate: Cascade)
  nucleus   Nucleus   @relation(fields: [idNucleus], references: [idNucleus], onDelete: Restrict, onUpdate: Cascade)
  semester  Semester  @relation(fields: [term], references: [term], onDelete: Restrict, onUpdate: Cascade)
  legalArea LegalArea @relation(fields: [idLegalArea], references: [idLegalArea], onDelete: Restrict, onUpdate: Cascade)
  teacher   Teacher?  @relation(fields: [teacherId, teacherTerm], references: [identityCard, term], onDelete: Restrict, onUpdate: Cascade)
  court     Court?    @relation(fields: [idCourt], references: [idCourt], onDelete: Restrict, onUpdate: Cascade)

  beneficiaries    CaseBeneficiary[]
  supports         SupportDocument[]
  actions          CaseAction[]
  appointments     Appointment[]
  statuses         CaseStatus[]
  assignedStudents AssignedStudent[]
}

model CaseBeneficiary {
  idCase        Int
  beneficiaryId String              @db.VarChar(20)
  relationship  String              @db.VarChar(200)
  type          CaseBeneficiaryType
  description   String              @db.VarChar(200)

  case        Case        @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)
  beneficiary Beneficiary @relation(fields: [beneficiaryId], references: [identityCard], onDelete: Restrict, onUpdate: Cascade)

  @@id([idCase, beneficiaryId])
}

model SupportDocument {
  idCase         Int
  supportNumber  Int
  title          String   @db.VarChar(200)
  description    String
  submissionDate DateTime
  fileUrl        String?

  case Case @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)

  @@id([idCase, supportNumber])
}

model CaseAction {
  idCase       Int
  actionNumber Int
  description  String
  notes        String?
  userId       String   @db.VarChar(20)
  registryDate DateTime

  case Case @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)
  user User @relation(fields: [userId], references: [identityCard], onDelete: Restrict, onUpdate: Cascade)

  @@id([idCase, actionNumber])
}

model Appointment {
  idCase            Int
  appointmentNumber Int
  plannedDate       DateTime
  executionDate     DateTime?
  status            AppointmentStatus
  guidance          String?
  userId            String?           @db.VarChar(20)
  registryDate      DateTime

  case Case  @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)
  user User? @relation(fields: [userId], references: [identityCard], onDelete: Restrict, onUpdate: Cascade)

  @@id([idCase, appointmentNumber])
}

model CaseStatus {
  idCase       Int
  statusNumber Int
  status       CaseStatusEnum
  reason       String?
  userId       String         @db.VarChar(20)
  registryDate DateTime

  case Case @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)
  user User @relation(fields: [userId], references: [identityCard], onDelete: Restrict, onUpdate: Cascade)

  @@id([idCase, statusNumber])
}

model AssignedStudent {
  idCase    Int
  studentId String @db.VarChar(20)
  term      String @db.VarChar(10)

  case    Case    @relation(fields: [idCase], references: [idCase], onDelete: Cascade, onUpdate: Cascade)
  student Student @relation(fields: [studentId, term], references: [identityCard, term], onDelete: Restrict, onUpdate: Cascade)

  @@id([idCase, studentId, term])
}
